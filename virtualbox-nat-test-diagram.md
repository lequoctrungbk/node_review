# VirtualBox NAT Traversal Test Setup Diagram

## High-Level Architecture

**3 VMs Total:**
- ğŸ”· **VM-Relay**: Public relay server (bridged + host-only)
- ğŸ”· **VM-NodeA**: Behind NAT A (192.168.100.10)
- ğŸ”· **VM-NodeB**: Behind NAT B (192.168.200.10)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               HOST MACHINE                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           INTERNET ACCESS                           â”‚   â”‚
â”‚  â”‚  (WiFi/Ethernet) - Real public IP or local network access          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      VIRTUALBOX HYPERVISOR                          â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â”‚                     VIRTUAL NETWORKS                           â”‚   â”‚
â”‚  â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  NAT Network A  â”‚    â”‚  NAT Network B  â”‚    â”‚ Host-only   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  192.168.100.0 â”‚    â”‚  192.168.200.0  â”‚    â”‚ 192.168.56.0â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚     /24         â”‚    â”‚     /24         â”‚    â”‚    /24       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                 â”‚    â”‚                 â”‚    â”‚              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚VM-NodeA â”‚    â”‚    â”‚  â”‚VM-NodeB â”‚    â”‚    â”‚  â”‚VM-Relayâ”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚192.168. â”‚    â”‚    â”‚  â”‚192.168. â”‚    â”‚    â”‚  â”‚192.168.â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚100.10   â”‚    â”‚    â”‚  â”‚200.10   â”‚    â”‚    â”‚  â”‚56.10   â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Alternative High-Level Architecture (Recommended)

**3 VMs Total (Bridged + iptables NAT Simulation):**
- ğŸ”· **VM-Relay**: Public relay server (bridged only)
- ğŸ”· **VM-NodeA**: Behind simulated NAT A (bridged + iptables rules)
- ğŸ”· **VM-NodeB**: Behind simulated NAT B (bridged + iptables rules)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               HOST MACHINE                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           INTERNET ACCESS                           â”‚   â”‚
â”‚  â”‚  (WiFi/Ethernet) - Real public IP or local network access          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      VIRTUALBOX HYPERVISOR                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â”‚         â”‚                SHARED NETWORK                     â”‚     â”‚   â”‚
â”‚  â”‚  â”‚ FIREWALLâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚   â”‚
â”‚  â”‚  â”‚ RULES   â”‚  â”‚              192.168.1.0/24                 â”‚  â”‚     â”‚   â”‚
â”‚  â”‚  â”‚(iptables)â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”‚  â”‚  â”‚VM-NodeA â”‚    â”‚VM-NodeB â”‚    â”‚VM-Relay â”‚  â”‚  â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”‚  â”‚  â”‚192.168. â”‚    â”‚192.168. â”‚    â”‚192.168. â”‚  â”‚  â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”‚  â”‚  â”‚1.101    â”‚    â”‚1.102    â”‚    â”‚1.100    â”‚  â”‚  â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Differences from Previous Setup:**
- âœ… **All VMs on same bridged network** (192.168.1.0/24)
- âœ… **Host iptables simulates NAT behavior** for each VM
- âœ… **Hole punching becomes possible** - VMs can establish direct connections
- âœ… **Real-world NAT simulation** - outbound allowed, inbound blocked except established
- âœ… **Flexible testing** - firewall rules can be adjusted for different NAT types

## Detailed Network Topology

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              PHYSICAL HOST                                  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                           HOST NETWORK CARD                          â”‚    â”‚
â”‚  â”‚  (WiFi: 192.168.1.100 or Ethernet with public IP)                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                       â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      VIRTUALBOX VIRTUAL SWITCH                       â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Bridged     â”‚  â”‚ Host-only   â”‚  â”‚ NAT Network â”‚  â”‚ NAT Network â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Adapter     â”‚  â”‚ Adapter     â”‚  â”‚ A           â”‚  â”‚ B           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ (Optional)  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚         â”‚                 â”‚                 â”‚                 â”‚        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                 â”‚                 â”‚                 â”‚           â”‚
â”‚            â–¼                 â–¼                 â–¼                 â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”     â”‚
â”‚  â”‚     VM-RELAY      â”‚  â”‚ VM-RELAYâ”‚  â”‚    VM-NODEA     â”‚  â”‚ VM-NODEBâ”‚     â”‚
â”‚  â”‚  (Bridged + Host) â”‚  â”‚(Host IP)â”‚  â”‚   (NAT A)       â”‚  â”‚  (NAT B) â”‚     â”‚
â”‚  â”‚                   â”‚  â”‚          â”‚  â”‚                 â”‚  â”‚          â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ 192.168.1.X â”‚  â”‚  â”‚  â”‚.10  â”‚ â”‚  â”‚  â”‚ .10      â”‚  â”‚  â”‚  â”‚ .10 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ (Bridged)   â”‚  â”‚  â”‚  â”‚     â”‚ â”‚  â”‚  â”‚          â”‚  â”‚  â”‚  â”‚     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                             â”‚
â”‚  Legend:                                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€  Virtual Network Cable                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”  Virtual Machine                                                  â”‚
â”‚  â—‡â”€â”€â”€â”€â—‡  Network Interface Card (Virtual)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## VM Configuration Details

### VM-Relay (Public Relay Server)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              VM-RELAY                                       â”‚
â”‚                          "Public" Server                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  VirtualBox Settings:                                                     â”‚
â”‚  â”œâ”€ OS: Ubuntu 22.04 Server                                               â”‚
â”‚  â”œâ”€ RAM: 2GB                                                              â”‚
â”‚  â”œâ”€ CPU: 2 cores                                                          â”‚
â”‚  â”œâ”€ Disk: 20GB                                                            â”‚
â”‚  â””â”€ Network: 2 Adapters                                                   â”‚
â”‚                                                                            â”‚
â”‚  Network Configuration:                                                   â”‚
â”‚  â”œâ”€ Adapter 1: Bridged Adapter                                            â”‚
â”‚  â”‚  â”œâ”€ Attached to: [Host WiFi/Ethernet card]                            â”‚
â”‚  â”‚  â”œâ”€ IP: DHCP (192.168.1.X from host router)                           â”‚
â”‚  â”‚  â””â”€ Purpose: Internet access + reachable by other VMs                 â”‚
â”‚  â”‚                                                                        â”‚
â”‚  â””â”€ Adapter 2: Host-only Adapter (vboxnet0)                               â”‚
â”‚     â”œâ”€ IP: 192.168.56.10/24                                              â”‚
â”‚     â””â”€ Purpose: Direct access from host machine                           â”‚
â”‚                                                                            â”‚
â”‚  Services Running:                                                        â”‚
â”‚  â”œâ”€ libp2p Relay Service (Port 4001)                                      â”‚
â”‚  â”œâ”€ HTTP API (Port 3000)                                                  â”‚
â”‚  â””â”€ NAT Traversal Coordinator                                             â”‚
â”‚                                                                            â”‚
â”‚  Data Flow:                                                               â”‚
â”‚  â”œâ”€ Receives: Relay requests from NAT nodes                              â”‚
â”‚  â”œâ”€ Sends: Coordination messages for hole punching                       â”‚
â”‚  â””â”€ Purpose: Enable P2P connections between NAT nodes                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### VM-NodeA (Behind NAT A)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              VM-NODEA                                      â”‚
â”‚                        Behind NAT Router A                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  VirtualBox Settings:                                                     â”‚
â”‚  â”œâ”€ OS: Ubuntu 22.04 Server                                               â”‚
â”‚  â”œâ”€ RAM: 1GB                                                              â”‚
â”‚  â”œâ”€ CPU: 1 core                                                           â”‚
â”‚  â”œâ”€ Disk: 10GB                                                            â”‚
â”‚  â””â”€ Network: 1 Adapter                                                    â”‚
â”‚                                                                            â”‚
â”‚  Network Configuration:                                                   â”‚
â”‚  â””â”€ Adapter 1: NAT Network A                                              â”‚
â”‚     â”œâ”€ IP: 192.168.100.10/24                                              â”‚
â”‚     â”œâ”€ Gateway: 192.168.100.1 (VirtualBox NAT router)                     â”‚
â”‚     â”œâ”€ Internet: Blocked (no inbound connections)                         â”‚
â”‚     â””â”€ Outbound: Only through NAT translation                             â”‚
â”‚                                                                            â”‚
â”‚  VirtualBox NAT Router Behavior:                                          â”‚
â”‚  â”œâ”€ Outbound: Translates source IP to host IP                             â”‚
â”‚  â”œâ”€ Inbound: Blocks unless explicit port forwarding                      â”‚
â”‚  â””â”€ NAT Type: Port Restricted Cone (realistic)                            â”‚
â”‚                                                                            â”‚
â”‚  Services Running:                                                        â”‚
â”‚  â”œâ”€ libp2p Client with NAT traversal                                      â”‚
â”‚  â”œâ”€ HTTP API (Port 3001) - forwarded from host                            â”‚
â”‚  â””â”€ Hole punching client                                                  â”‚
â”‚                                                                            â”‚
â”‚  Data Flow:                                                               â”‚
â”‚  â”œâ”€ Connects to: VM-Relay for bootstrap                                   â”‚
â”‚  â”œâ”€ Discovers: VM-NodeB through relay                                     â”‚
â”‚  â”œâ”€ Attempts: Hole punching to establish direct P2P                      â”‚
â”‚  â””â”€ Result: Direct connection to VM-NodeB (bypassing relay)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### VM-NodeB (Behind NAT B)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              VM-NODEB                                      â”‚
â”‚                        Behind NAT Router B                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  VirtualBox Settings:                                                     â”‚
â”‚  â”œâ”€ OS: Ubuntu 22.04 Server                                               â”‚
â”‚  â”œâ”€ RAM: 1GB                                                              â”‚
â”‚  â”œâ”€ CPU: 1 core                                                           â”‚
â”‚  â”œâ”€ Disk: 10GB                                                            â”‚
â”‚  â””â”€ Network: 1 Adapter                                                    â”‚
â”‚                                                                            â”‚
â”‚  Network Configuration:                                                   â”‚
â”‚  â””â”€ Adapter 1: NAT Network B                                              â”‚
â”‚     â”œâ”€ IP: 192.168.100.10/24                                              â”‚
â”‚     â”œâ”€ Gateway: 192.168.200.1 (VirtualBox NAT router)                     â”‚
â”‚     â”œâ”€ Internet: Blocked (no inbound connections)                         â”‚
â”‚     â””â”€ Outbound: Only through NAT translation                             â”‚
â”‚                                                                            â”‚
â”‚  VirtualBox NAT Router Behavior:                                          â”‚
â”‚  â”œâ”€ Outbound: Translates source IP to host IP                             â”‚
â”‚  â”œâ”€ Inbound: Blocks unless explicit port forwarding                      â”‚
â”‚  â””â”€ NAT Type: Port Restricted Cone (realistic)                            â”‚
â”‚                                                                            â”‚
â”‚  Services Running:                                                        â”‚
â”‚  â”œâ”€ libp2p Client with NAT traversal                                      â”‚
â”‚  â”œâ”€ HTTP API (Port 3002) - forwarded from host                            â”‚
â”‚  â””â”€ Hole punching client                                                  â”‚
â”‚                                                                            â”‚
â”‚  Data Flow:                                                               â”‚
â”‚  â”œâ”€ Connects to: VM-Relay for bootstrap                                   â”‚
â”‚  â”œâ”€ Discovers: VM-NodeA through relay                                     â”‚
â”‚  â”œâ”€ Attempts: Hole punching to establish direct P2P                      â”‚
â”‚  â””â”€ Result: Direct connection to VM-NodeA (bypassing relay)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          P2P NAT TRAVERSAL FLOW                           â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  VM-NodeA   â”‚    â”‚NAT Router A â”‚    â”‚   INTERNET  â”‚    â”‚NAT Router B â”‚   â”‚
â”‚  â”‚             â”‚    â”‚             â”‚    â”‚             â”‚    â”‚             â”‚   â”‚
â”‚  â”‚ 192.168.    â”‚â—„â”€â”€â–ºâ”‚ Translates   â”‚â—„â”€â”€â–ºâ”‚ Host Machine â”‚â—„â”€â”€â–ºâ”‚ Translates   â”‚   â”‚
â”‚  â”‚ 100.10      â”‚    â”‚ IP/Ports    â”‚    â”‚             â”‚    â”‚ IP/Ports    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                     â”‚                              â”‚
â”‚         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚         â”‚         â”‚                           â”‚                         â”‚    â”‚
â”‚         â–¼         â–¼                           â–¼                         â–¼    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚libp2p Clientâ”‚ â”‚   VM-RELAY      â”‚ â”‚libp2p Relayâ”‚ â”‚   VM-NodeB       â”‚    â”‚
â”‚  â”‚             â”‚ â”‚  (Coordinator)  â”‚ â”‚             â”‚ â”‚                 â”‚    â”‚
â”‚  â”‚Port: 4002   â”‚â—„â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â–ºâ”‚Port: 4001   â”‚â—„â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â–º   â”‚
â”‚  â”‚             â”‚ â”‚                 â”‚ â”‚             â”‚ â”‚ 192.168.200.10  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ 192.168.56.10  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚Port: 4003        â”‚    â”‚
â”‚                  â”‚                 â”‚                 â”‚                  â”‚    â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â”‚  Connection Establishment:                                                  â”‚
â”‚  1. VM-NodeA â†’ VM-Relay: Register as peer                                  â”‚
â”‚  2. VM-NodeB â†’ VM-Relay: Register as peer                                  â”‚
â”‚  3. VM-Relay: Coordinate hole punching between NodeA & NodeB              â”‚
â”‚  4. VM-NodeA & VM-NodeB: Simultaneous connect attempts                     â”‚
â”‚  5. NAT Routers: Create port mappings (holes)                             â”‚
â”‚  6. Result: Direct P2P connection established                              â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    SUCCESSFUL HOLE PUNCHING                        â”‚    â”‚
â”‚  â”‚  VM-NodeA:192.168.100.10:4002 â†” VM-NodeB:192.168.200.10:4003      â”‚    â”‚
â”‚  â”‚  (Direct P2P, no relay needed)                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## IP Address Assignment Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          IP ADDRESS ASSIGNMENTS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Host Machine:                                                             â”‚
â”‚  â”œâ”€ External IP: DHCP from host network (192.168.1.100)                   â”‚
â”‚  â””â”€ vboxnet0: 192.168.56.1 (Host-only network gateway)                    â”‚
â”‚                                                                           â”‚
â”‚  VM-Relay:                                                                â”‚
â”‚  â”œâ”€ Bridged: 192.168.1.X (from host router DHCP)                         â”‚
â”‚  â”œâ”€ Host-only: 192.168.56.10 (static)                                     â”‚
â”‚  â”œâ”€ Services:                                                             â”‚
â”‚  â”‚  â”œâ”€ libp2p Relay: :4001                                                â”‚
â”‚  â”‚  â””â”€ HTTP API: :3000                                                    â”‚
â”‚  â””â”€ Purpose: Publicly accessible relay server                             â”‚
â”‚                                                                           â”‚
â”‚  VM-NodeA:                                                                â”‚
â”‚  â”œâ”€ NAT Network A: 192.168.100.10 (static)                                â”‚
â”‚  â”œâ”€ Gateway: 192.168.100.1 (VirtualBox NAT router)                        â”‚
â”‚  â”œâ”€ Services:                                                             â”‚
â”‚  â”‚  â”œâ”€ libp2p Client: :4002                                               â”‚
â”‚  â”‚  â””â”€ HTTP API: :3001 (forwarded from host)                              â”‚
â”‚  â””â”€ Purpose: Node behind NAT, needs hole punching                         â”‚
â”‚                                                                           â”‚
â”‚  VM-NodeB:                                                                â”‚
â”‚  â”œâ”€ NAT Network B: 192.168.200.10 (static)                                â”‚
â”‚  â”œâ”€ Gateway: 192.168.200.1 (VirtualBox NAT router)                        â”‚
â”‚  â”œâ”€ Services:                                                             â”‚
â”‚  â”‚  â”œâ”€ libp2p Client: :4003                                               â”‚
â”‚  â”‚  â””â”€ HTTP API: :3002 (forwarded from host)                              â”‚
â”‚  â””â”€ Purpose: Node behind NAT, needs hole punching                         â”‚
â”‚                                                                           â”‚
â”‚  VirtualBox Networks:                                                     â”‚
â”‚  â”œâ”€ NAT Network A: 192.168.100.0/24                                       â”‚
â”‚  â”‚  â””â”€ Subnet for VM-NodeA (isolated from other networks)                 â”‚
â”‚  â”œâ”€ NAT Network B: 192.168.200.0/24                                       â”‚
â”‚  â”‚  â””â”€ Subnet for VM-NodeB (isolated from other networks)                 â”‚
â”‚  â””â”€ Host-only: 192.168.56.0/24                                            â”‚
â”‚     â””â”€ Direct communication between VMs and host                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## How VirtualBox Acts as NAT Router

### VirtualBox NAT Router Behavior

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       VIRTUALBOX AS NAT ROUTER                             â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚      VM-NodeA           â”‚    â”‚   VirtualBox NAT Router  â”‚                â”‚
â”‚  â”‚  192.168.100.10         â”‚    â”‚  192.168.100.1          â”‚                â”‚
â”‚  â”‚                         â”‚    â”‚                         â”‚                â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                â”‚
â”‚  â”‚  â”‚Outbound Request â”‚    â”‚    â”‚  â”‚ NAT Translation â”‚    â”‚                â”‚
â”‚  â”‚  â”‚192.168.100.10: â”‚â”€â”€â”€â”€â–¶â”‚â”€â”€â”€â”€â–¶â”‚  â”‚ Table           â”‚    â”‚                â”‚
â”‚  â”‚  â”‚  4002 â†’ 8.8.8.8â”‚    â”‚    â”‚  â”‚                 â”‚    â”‚                â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚ â”‚192.168.100.â”‚ â”‚    â”‚                â”‚
â”‚                                 â”‚    â”‚ â”‚10:4002 â†’   â”‚ â”‚    â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚ â”‚HostIP:55001 â”‚ â”‚    â”‚                â”‚
â”‚  â”‚      INTERNET           â”‚    â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚                â”‚
â”‚  â”‚                         â”‚    â”‚  â”‚                 â”‚    â”‚                â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚                â”‚
â”‚  â”‚  â”‚Inbound Response â”‚    â”‚    â”‚  â”‚  â”‚Inbound     â”‚â—€â”€â”€â”€â”‚â—€â”€â”€â”€Blocked!     â”‚
â”‚  â”‚  â”‚HostIP:55001     â”‚â—€â”€â”€â”€â”‚â—€â”€â”€â”€â”‚â—€â”€â”€â”‚  â”‚Blocks!    â”‚    â”‚                â”‚
â”‚  â”‚  â”‚   â† 8.8.8.8     â”‚    â”‚    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚                â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                         â”‚                â”‚
â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                           â”‚
â”‚  Key Behaviors:                                                          â”‚
â”‚  â”œâ”€ Outbound: Translates VM private IP â†’ Host public IP                 â”‚
â”‚  â”œâ”€ Inbound: Blocks unless explicit mapping exists                      â”‚
â”‚  â””â”€ Port Mapping: Dynamic for outbound, manual for inbound              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### NAT Translation Process

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       NAT TRANSLATION PROCESS                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step 1: VM Sends Outbound Packet                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ VM-NodeA (192.168.100.10) sends packet to VM-Relay (192.168.56.10) â”‚   â”‚
â”‚  â”‚ Source: 192.168.100.10:4002                                          â”‚   â”‚
â”‚  â”‚ Destination: 192.168.56.10:4001                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                           â”‚
â”‚  Step 2: VirtualBox NAT Router Intercepts                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ NAT Router sees packet going to different network                    â”‚   â”‚
â”‚  â”‚ Checks translation table: No existing mapping                        â”‚   â”‚
â”‚  â”‚ Creates new mapping: 192.168.100.10:4002 â†’ HostIP:DynamicPort        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                           â”‚
â”‚  Step 3: Packet Translation                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Source IP changed: 192.168.100.10 â†’ HostIP                          â”‚   â”‚
â”‚  â”‚ Source Port changed: 4002 â†’ DynamicPort (e.g., 55001)               â”‚   â”‚
â”‚  â”‚ Packet forwarded to destination                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                           â”‚
â”‚  Step 4: Return Path                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ VM-Relay sends response back to HostIP:DynamicPort                   â”‚   â”‚
â”‚  â”‚ NAT Router looks up mapping: HostIP:DynamicPort â†’ 192.168.100.10:4002â”‚   â”‚
â”‚  â”‚ Translates destination: HostIP:DynamicPort â†’ 192.168.100.10:4002     â”‚   â”‚
â”‚  â”‚ Packet delivered to VM-NodeA                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                           â”‚
â”‚  Step 5: Translation Table Entry                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Internal IP:Port â”‚ External IP:Port â”‚ Protocol â”‚ Timeout             â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚   â”‚
â”‚  â”‚192.168.100.10:4002â”‚ HostIP:55001    â”‚ TCP      â”‚ 300s    â”‚           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Why Hole Punching is Needed

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WHY HOLE PUNCHING IS NEEDED                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Scenario: VM-NodeA wants direct P2P connection with VM-NodeB             â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   VM-NodeA      â”‚    â”‚ NAT Router A    â”‚    â”‚   VM-NodeB      â”‚        â”‚
â”‚  â”‚ 192.168.100.10  â”‚    â”‚ 192.168.100.1   â”‚    â”‚ 192.168.200.10  â”‚        â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚        â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚        â”‚
â”‚  â”‚ â”‚Send SYN to  â”‚ â”‚    â”‚ â”‚No mapping forâ”‚ â”‚    â”‚ â”‚Waiting for  â”‚ â”‚        â”‚
â”‚  â”‚ â”‚VM-NodeB     â”‚ â”‚    â”‚ â”‚VM-NodeB IP! â”‚ â”‚    â”‚ â”‚connection   â”‚ â”‚        â”‚
â”‚  â”‚ â”‚192.168.200.â”‚ â”‚    â”‚ â”‚             â”‚ â”‚    â”‚ â”‚             â”‚ â”‚        â”‚
â”‚  â”‚ â”‚10:4003      â”‚ â”‚    â”‚ â”‚   BLOCKS!   â”‚ â”‚    â”‚ â”‚             â”‚ â”‚        â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                           â”‚
â”‚  Problem: NAT routers don't allow inbound connections from unknown IPs   â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    HOLE PUNCHING SOLUTION                          â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ 1. Both VMs connect to relay server                                â”‚   â”‚
â”‚  â”‚ 2. Relay coordinates simultaneous connection attempts              â”‚   â”‚
â”‚  â”‚ 3. VMs send packets to each other at exact same time               â”‚   â”‚
â”‚  â”‚ 4. NAT routers create "holes" (temporary mappings)                 â”‚   â”‚
â”‚  â”‚ 5. Direct P2P connection established!                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   VM-NodeA      â”‚    â”‚ NAT Router A    â”‚    â”‚   VM-NodeB      â”‚        â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚        â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚        â”‚
â”‚  â”‚ â”‚Hole punched!â”‚ â”‚    â”‚ â”‚Port mapping â”‚ â”‚    â”‚ â”‚Hole punched!â”‚ â”‚        â”‚
â”‚  â”‚ â”‚Direct P2P   â”‚â—€â”€â”€â”€â”€â–¶â”‚ â”‚created!     â”‚â—€â”€â”€â”€â”€â–¶â”‚ â”‚Direct P2P   â”‚ â”‚        â”‚
â”‚  â”‚ â”‚connection   â”‚ â”‚    â”‚ â”‚192.168.200.â”‚ â”‚    â”‚ â”‚connection   â”‚ â”‚        â”‚
â”‚  â”‚ â”‚established! â”‚ â”‚    â”‚ â”‚10:4003 open â”‚ â”‚    â”‚ â”‚established! â”‚ â”‚        â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### VirtualBox NAT vs Real Router Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               VIRTUALBOX NAT vs REAL ROUTER COMPARISON                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Feature                  â”‚ VirtualBox NAT Router â”‚ Real Home Router       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Outbound Traffic          â”‚ âœ… Translates source   â”‚ âœ… Translates source   â”‚
â”‚ Inbound Traffic           â”‚ âŒ Blocks by default   â”‚ âŒ Blocks by default   â”‚
â”‚ Port Forwarding           â”‚ âš ï¸ Manual only         â”‚ âš ï¸ Manual configuration â”‚
â”‚ NAT Type                  â”‚ Port Restricted Cone  â”‚ Varies (Full/Restrictedâ”‚
â”‚ DHCP Server               â”‚ âœ… Built-in            â”‚ âœ… Built-in            â”‚
â”‚ Firewall Rules            â”‚ âš ï¸ Limited             â”‚ âœ… Advanced            â”‚
â”‚ Connection Tracking       â”‚ âœ… Automatic           â”‚ âœ… Automatic           â”‚
â”‚ UPnP Support              â”‚ âŒ Not supported       â”‚ âš ï¸ Sometimes supported â”‚
â”‚ Traffic Monitoring        â”‚ âš ï¸ Limited             â”‚ âœ… Advanced logging    â”‚
â”‚ Multiple Networks         â”‚ âœ… Easy (NAT Net A/B)  â”‚ âš ï¸ Complex VLAN setup  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ P2P NAT Traversal Testing â”‚ âœ… Perfect simulation  â”‚ âŒ Hard to control     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Network Isolation Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        NETWORK CONNECTIVITY MATRIX                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ From \ To       â”‚ VM-Relay    â”‚ VM-NodeA    â”‚ VM-NodeB    â”‚ Host Machine    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VM-Relay        â”‚     âœ“       â”‚     âœ“       â”‚     âœ“       â”‚       âœ“         â”‚
â”‚ (Bridged + Host)â”‚             â”‚             â”‚             â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VM-NodeA        â”‚     âœ“       â”‚     âœ—       â”‚ âš ï¸ (after holeâ”‚       âœ—         â”‚
â”‚ (Bridged + NAT) â”‚             â”‚             â”‚   punching) â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VM-NodeB        â”‚     âœ“       â”‚ âš ï¸ (after holeâ”‚     âœ—       â”‚       âœ—         â”‚
â”‚ (Bridged + NAT) â”‚             â”‚   punching) â”‚             â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Host Machine    â”‚     âœ“       â”‚     âœ—       â”‚     âœ—       â”‚       âœ“         â”‚
â”‚                 â”‚             â”‚             â”‚                 â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ“ = Can communicate directly
âš ï¸ = Possible after successful hole punching (requires firewall rules)
âŒ = Cannot perform hole punching (NAT network isolation)
âœ— = Cannot communicate directly (needs NAT traversal/firewall rules)

---

## Network Comparison: NAT Networks vs Bridged + iptables

### Current Setup (NAT Networks) - Limited Testing
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ From \ To       â”‚ VM-Relay    â”‚ VM-NodeA    â”‚ VM-NodeB        â”‚ Host Machine    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VM-Relay        â”‚     âœ“       â”‚     âœ“       â”‚       âœ“         â”‚       âœ“         â”‚
â”‚ (Bridged+Host)  â”‚             â”‚             â”‚                 â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VM-NodeA        â”‚ âš ï¸ (port fwd)â”‚     âœ—       â”‚       âœ—         â”‚       âœ—         â”‚
â”‚ (NAT Network A) â”‚  âŒ No hole  â”‚             â”‚                 â”‚                 â”‚
â”‚                 â”‚   punching   â”‚             â”‚                 â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VM-NodeB        â”‚ âš ï¸ (port fwd)â”‚     âœ—       â”‚       âœ—         â”‚       âœ—         â”‚
â”‚ (NAT Network B) â”‚  âŒ No hole  â”‚             â”‚                 â”‚                 â”‚
â”‚                 â”‚   punching   â”‚             â”‚                 â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Host Machine    â”‚     âœ“       â”‚     âœ—       â”‚       âœ—         â”‚       âœ“         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Recommended Setup (Bridged + iptables) - Full Testing
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ From \ To       â”‚ VM-Relay    â”‚ VM-NodeA    â”‚ VM-NodeB        â”‚ Host Machine    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VM-Relay        â”‚     âœ“       â”‚     âœ“       â”‚       âœ“         â”‚       âœ“         â”‚
â”‚ (Bridged)       â”‚             â”‚             â”‚                 â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VM-NodeA        â”‚     âœ“       â”‚     âœ—       â”‚ âš ï¸ (after hole   â”‚       âœ“         â”‚
â”‚ (Bridged+NAT)   â”‚             â”‚             â”‚   punching)     â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VM-NodeB        â”‚     âœ“       â”‚ âš ï¸ (after holeâ”‚       âœ—         â”‚       âœ“         â”‚
â”‚ (Bridged+NAT)   â”‚             â”‚   punching) â”‚                 â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Host Machine    â”‚     âœ“       â”‚     âœ“       â”‚       âœ“         â”‚       âœ“         â”‚
â”‚ (iptables)      â”‚             â”‚             â”‚                 â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Comparison Summary:**
- **NAT Networks**: Limited to relay testing only âŒ
- **Bridged + iptables**: Full NAT traversal testing possible âœ…
- **Hole Punching**: Only possible with bridged setup âœ…

## Important: NAT Network Limitations & Port Forwarding Analysis

### **âŒ Port Forwarding is NOT Enough for Hole Punching**

**Main Issue**: Port forwarding only allows VMs to connect to the relay, but **cannot perform hole punching** because:

1. **VM-NodeA** and **VM-NodeB** remain on isolated NAT networks
2. They **cannot connect directly** to each other (required condition for hole punching)
3. VirtualBox NAT networks **only allow outbound traffic**, not inbound connections

**Result**: The model can test relay functionality but **cannot test hole punching**.

---

### **âœ… Giáº£i phÃ¡p HOÃ€N CHá»ˆNH: Bridged Adapters + Manual NAT Simulation**

#### **BÆ°á»›c 1: Cáº¥u hÃ¬nh Network Adapters**
```
VM-Relay:  Bridged Adapter â†’ 192.168.1.X (cÃ¹ng subnet host)
VM-NodeA:  Bridged Adapter â†’ 192.168.1.Y (cÃ¹ng subnet host)
VM-NodeB:  Bridged Adapter â†’ 192.168.1.Z (cÃ¹ng subnet host)
```

#### **BÆ°á»›c 2: Simulate NAT báº±ng Host Machine Firewall**
**Idea**: Use the host machine as a "NAT router" with iptables/firewall rules:

**VM-NodeA (192.168.1.101):**
```bash
# Host machine iptables rules for NodeA
iptables -t nat -A POSTROUTING -s 192.168.1.101 -o wlan0 -j MASQUERADE
iptables -A FORWARD -i vboxnet0 -o wlan0 -s 192.168.1.101 -j ACCEPT
iptables -A FORWARD -i wlan0 -o vboxnet0 -d 192.168.1.101 -m state --state RELATED,ESTABLISHED -j ACCEPT
# Block inbound from other VMs except established connections
iptables -A FORWARD -i vboxnet0 -d 192.168.1.101 -s 192.168.1.0/24 -j DROP
```

**VM-NodeB (192.168.1.102):**
```bash
# Similar rules for NodeB
iptables -t nat -A POSTROUTING -s 192.168.1.102 -o wlan0 -j MASQUERADE
iptables -A FORWARD -i vboxnet0 -o wlan0 -s 192.168.1.102 -j ACCEPT
iptables -A FORWARD -i wlan0 -o vboxnet0 -d 192.168.1.102 -m state --state RELATED,ESTABLISHED -j ACCEPT
# Block inbound from other VMs
iptables -A FORWARD -i vboxnet0 -d 192.168.1.102 -s 192.168.1.0/24 -j DROP
```

#### **BÆ°á»›c 3: Expected Behavior**

**âŒ WITHOUT iptables rules (Direct Bridged):**
- VM-NodeA can ping VM-NodeB directly âœ— (not realistic NAT behavior)
- VMs can communicate freely (no NAT simulation)

**âœ… WITH iptables rules (NAT Simulation):**
- **Outbound**: VMs can connect to VM-Relay and internet âœ“
- **Inbound**: VMs **cannot** receive connections from other VMs (except established) âœ“
- **Hole Punching**: VMs can connect directly after relay coordinates âœ“

---

### **âš ï¸ Critical: iptables Rules Are Essential**

**Why iptables rules matter:**

1. **Without Rules**: Bridged setup = VMs can ping each other directly âŒ
2. **With Rules**: Proper NAT simulation = VMs cannot initiate inbound connections âœ…

**Testing connectivity BEFORE applying rules:**
```bash
# From VM-NodeA (192.168.1.101):
ping 192.168.1.102    # Will work - direct communication âŒ

# From VM-NodeA (trying to connect to VM-NodeB's service):
telnet 192.168.1.102 4003  # Will connect - no NAT blocking âŒ
```

**Testing connectivity AFTER applying rules:**
```bash
# From VM-NodeA:
ping 192.168.1.102    # Will fail - blocked by firewall âœ…
telnet 192.168.1.102 4003  # Will fail - blocked by firewall âœ…

# But outbound connections still work:
curl google.com       # Works - NAT allows outbound âœ…
```

**The iptables rules create the "NAT barrier" that makes hole punching necessary and possible.**

#### **BÆ°á»›c 4: Test Scenarios**
```
1. VM-Relay: 192.168.1.100 (publicly accessible)
2. VM-NodeA: 192.168.1.101 (behind "NAT A")  
3. VM-NodeB: 192.168.1.102 (behind "NAT B")

Hole Punching Flow:
VM-NodeA â†’ VM-Relay (ok, outbound allowed)
VM-NodeB â†’ VM-Relay (ok, outbound allowed)
Relay coordinates â†’ VMs attempt direct connection
NAT rules allow simultaneous connects â†’ Hole punching succeeds!
```

#### **Benefits of this solution:**
- âœ… **Real NAT simulation** with iptables rules
- âœ… **Hole punching feasible** - VMs can direct connect
- âœ… **Flexible testing** - can adjust firewall rules
- âœ… **Close to real-world** - similar to home router NAT behavior

---

### **âš ï¸ Workaround with Port Forwarding (Limited Testing)**

If still want to use NAT networks + port forwarding:

1. **Relay Connection**: VMs connect to relay via port forwarding âœ“
2. **Hole Punching**: Will fail because cannot direct connection âœ—
3. **Testing Scope**: Only test relay discovery and relay-mediated connections

**Conclusion**: Port forwarding **is not enough** for full NAT traversal testing.

---

### **ğŸ“‹ Complete Implementation Guide: Bridged + Firewall Setup**

#### **Network Configuration:**
```
Host Machine: 192.168.1.1 (gateway for VMs)
VM-Relay:    192.168.1.100 (bridged, no firewall rules)
VM-NodeA:    192.168.1.101 (bridged, with NAT simulation)
VM-NodeB:    192.168.1.102 (bridged, with NAT simulation)
```

#### **iptables Setup Script (Run on Host Machine):**
```bash
#!/bin/bash
# Enable IP forwarding
sudo sysctl -w net.ipv4.ip_forward=1

# Flush existing rules
sudo iptables -t nat -F
sudo iptables -t filter -F

# VM-NodeA NAT simulation (192.168.1.101)
sudo iptables -t nat -A POSTROUTING -s 192.168.1.101 -o wlan0 -j MASQUERADE
sudo iptables -A FORWARD -i vboxnet0 -o wlan0 -s 192.168.1.101 -j ACCEPT
sudo iptables -A FORWARD -i wlan0 -o vboxnet0 -d 192.168.1.101 -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i vboxnet0 -d 192.168.1.101 -s 192.168.1.0/24 -j DROP

# VM-NodeB NAT simulation (192.168.1.102)
sudo iptables -t nat -A POSTROUTING -s 192.168.1.102 -o wlan0 -j MASQUERADE
sudo iptables -A FORWARD -i vboxnet0 -o wlan0 -s 192.168.1.102 -j ACCEPT
sudo iptables -A FORWARD -i wlan0 -o vboxnet0 -d 192.168.1.102 -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i vboxnet0 -d 192.168.1.102 -s 192.168.1.0/24 -j DROP

# Allow local traffic
sudo iptables -A INPUT -i lo -j ACCEPT
sudo iptables -A INPUT -i vboxnet0 -j ACCEPT
```

#### **Testing the Setup:**

**Step 1: Test BEFORE applying iptables rules (should work):**
```bash
# From VM-NodeA (192.168.1.101):
ping 192.168.1.102    # Should work - direct VM communication âŒ
telnet 192.168.1.102 4003  # Should connect - no firewall blocking âŒ
```

**Step 2: Apply iptables rules on host machine**

**Step 3: Test AFTER applying iptables rules:**
```bash
# From VM-NodeA (192.168.1.101):
ping 192.168.1.100    # Should work (to relay) âœ…
ping 8.8.8.8          # Should work (to internet) âœ…
ping 192.168.1.102    # Should fail (blocked by firewall) âœ…
telnet 192.168.1.102 4003  # Should fail (blocked by firewall) âœ…
```

**Step 4: Test hole punching success:**
```bash
# After relay coordinates hole punching:
# VMs should establish direct P2P connection
# Connection should work despite firewall rules (established state)
```

**Recommendation:** **Use bridged adapters + host iptables** for a complete hole punching testing model closest to real-world scenarios.
```

## Test Scenarios

### Scenario 1: Successful Hole Punching (with Bridged + Firewall Setup)
```
1. Configure host iptables rules to simulate NAT
2. Start VM-Relay (relay service at 192.168.1.100)
3. Start VM-NodeA (connects to relay, "behind NAT")
4. Start VM-NodeB (connects to relay, "behind NAT")
5. Relay coordinates hole punching
6. VMs attempt simultaneous direct connections
7. Firewall allows established connections
8. Result: VM-NodeA â†” VM-NodeB (direct P2P, no relay needed!)
```

### Scenario 1.5: Hole Punching Failure (Restrictive Firewall)
```
1. Configure stricter iptables rules (block port ranges)
2. Start services as above
3. Hole punching attempts fail
4. Fallback to relay-mediated connection
5. Result: VM-NodeA â†” VM-Relay â†” VM-NodeB (relay required)
```

### Scenario 2: Relay Fallback
```
1. Start VM-Relay (relay service)
2. Start VM-NodeA (connects to relay)
3. Start VM-NodeB (connects to relay)
4. Hole punching fails (NAT too restrictive)
5. Fallback to relay-mediated connection
6. Result: VM-NodeA â†” VM-Relay â†” VM-NodeB
```

### Scenario 3: Network Monitoring
```
1. Host machine runs Wireshark
2. Monitor traffic on virtual network interfaces
3. Capture hole punching attempts
4. Analyze NAT translation behavior
5. Debug connection failures
```

This diagram provides a comprehensive visualization of the VirtualBox NAT traversal test setup, showing how the virtual networks, VMs, and NAT routers work together to create a realistic P2P testing environment.
